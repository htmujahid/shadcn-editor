{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "image-plugin",
  "type": "registry:ui",
  "author": "shadcn (https://ui.shadcn.com)",
  "files": [
    {
      "path": "editor/plugins/images-plugin.tsx",
      "content": "'use client'\r\n\r\n/**\r\n * Copyright (c) Meta Platforms, Inc. and affiliates.\r\n *\r\n * This source code is licensed under the MIT license found in the\r\n * LICENSE file in the root directory of this source tree.\r\n *\r\n */\r\nimport { useEffect, useRef, useState, JSX } from 'react'\r\nimport * as React from 'react'\r\n\r\nimport { useLexicalComposerContext } from '@lexical/react/LexicalComposerContext'\r\nimport { $wrapNodeInElement, mergeRegister } from '@lexical/utils'\r\nimport {\r\n  $createParagraphNode,\r\n  $createRangeSelection,\r\n  $getSelection,\r\n  $insertNodes,\r\n  $isNodeSelection,\r\n  $isRootOrShadowRoot,\r\n  $setSelection,\r\n  COMMAND_PRIORITY_EDITOR,\r\n  COMMAND_PRIORITY_HIGH,\r\n  COMMAND_PRIORITY_LOW,\r\n  DRAGOVER_COMMAND,\r\n  DRAGSTART_COMMAND,\r\n  DROP_COMMAND,\r\n  LexicalCommand,\r\n  LexicalEditor,\r\n  createCommand,\r\n} from 'lexical'\r\n\r\nimport { Button } from '@/registry/default/ui/button'\r\nimport { DialogFooter } from '@/registry/default/ui/dialog'\r\nimport { Input } from '@/registry/default/ui/input'\r\nimport { Label } from '@/registry/default/ui/label'\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/registry/default/ui/tabs'\r\n\r\nimport {\r\n  $createImageNode,\r\n  $isImageNode,\r\n  ImageNode,\r\n  ImagePayload,\r\n} from '@/registry/default/editor/nodes/image-node'\r\nimport { CAN_USE_DOM } from '@/registry/default/editor/shared/can-use-dom'\r\n\r\nexport type InsertImagePayload = Readonly<ImagePayload>\r\n\r\nconst getDOMSelection = (targetWindow: Window | null): Selection | null =>\r\n  CAN_USE_DOM ? (targetWindow || window).getSelection() : null\r\n\r\nexport const INSERT_IMAGE_COMMAND: LexicalCommand<InsertImagePayload> =\r\n  createCommand('INSERT_IMAGE_COMMAND')\r\n\r\nexport function InsertImageUriDialogBody({\r\n  onClick,\r\n}: {\r\n  onClick: (payload: InsertImagePayload) => void\r\n}) {\r\n  const [src, setSrc] = useState('')\r\n  const [altText, setAltText] = useState('')\r\n\r\n  const isDisabled = src === ''\r\n\r\n  return (\r\n    <div className=\"grid gap-4 py-4\">\r\n      <div className=\"grid gap-2\">\r\n        <Label htmlFor=\"image-url\">Image URL</Label>\r\n        <Input\r\n          id=\"image-url\"\r\n          placeholder=\"i.e. https://source.unsplash.com/random\"\r\n          onChange={(e) => setSrc(e.target.value)}\r\n          value={src}\r\n          data-test-id=\"image-modal-url-input\"\r\n        />\r\n      </div>\r\n      <div className=\"grid gap-2\">\r\n        <Label htmlFor=\"alt-text\">Alt Text</Label>\r\n        <Input\r\n          id=\"alt-text\"\r\n          placeholder=\"Random unsplash image\"\r\n          onChange={(e) => setAltText(e.target.value)}\r\n          value={altText}\r\n          data-test-id=\"image-modal-alt-text-input\"\r\n        />\r\n      </div>\r\n      <DialogFooter>\r\n        <Button\r\n          type=\"submit\"\r\n          disabled={isDisabled}\r\n          onClick={() => onClick({ altText, src })}\r\n          data-test-id=\"image-modal-confirm-btn\"\r\n        >\r\n          Confirm\r\n        </Button>\r\n      </DialogFooter>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport function InsertImageUploadedDialogBody({\r\n  onClick,\r\n}: {\r\n  onClick: (payload: InsertImagePayload) => void\r\n}) {\r\n  const [src, setSrc] = useState('')\r\n  const [altText, setAltText] = useState('')\r\n\r\n  const isDisabled = src === ''\r\n\r\n  const loadImage = (files: FileList | null) => {\r\n    const reader = new FileReader()\r\n    reader.onload = function () {\r\n      if (typeof reader.result === 'string') {\r\n        setSrc(reader.result)\r\n      }\r\n      return ''\r\n    }\r\n    if (files !== null) {\r\n      reader.readAsDataURL(files[0])\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"grid gap-4 py-4\">\r\n      <div className=\"grid gap-2\">\r\n        <Label htmlFor=\"image-upload\">Image Upload</Label>\r\n        <Input\r\n          id=\"image-upload\"\r\n          type=\"file\"\r\n          onChange={(e) => loadImage(e.target.files)}\r\n          accept=\"image/*\"\r\n          data-test-id=\"image-modal-file-upload\"\r\n        />\r\n      </div>\r\n      <div className=\"grid gap-2\">\r\n        <Label htmlFor=\"alt-text\">Alt Text</Label>\r\n        <Input\r\n          id=\"alt-text\"\r\n          placeholder=\"Descriptive alternative text\"\r\n          onChange={(e) => setAltText(e.target.value)}\r\n          value={altText}\r\n          data-test-id=\"image-modal-alt-text-input\"\r\n        />\r\n      </div>\r\n      <Button\r\n        type=\"submit\"\r\n        disabled={isDisabled}\r\n        onClick={() => onClick({ altText, src })}\r\n        data-test-id=\"image-modal-file-upload-btn\"\r\n      >\r\n        Confirm\r\n      </Button>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport function InsertImageDialog({\r\n  activeEditor,\r\n  onClose,\r\n}: {\r\n  activeEditor: LexicalEditor\r\n  onClose: () => void\r\n}): JSX.Element {\r\n  const hasModifier = useRef(false)\r\n\r\n  useEffect(() => {\r\n    hasModifier.current = false\r\n    const handler = (e: KeyboardEvent) => {\r\n      hasModifier.current = e.altKey\r\n    }\r\n    document.addEventListener('keydown', handler)\r\n    return () => {\r\n      document.removeEventListener('keydown', handler)\r\n    }\r\n  }, [activeEditor])\r\n\r\n  const onClick = (payload: InsertImagePayload) => {\r\n    activeEditor.dispatchCommand(INSERT_IMAGE_COMMAND, payload)\r\n    onClose()\r\n  }\r\n\r\n  return (\r\n    <Tabs defaultValue=\"url\">\r\n      <TabsList className=\"w-full\">\r\n        <TabsTrigger value=\"url\" className=\"w-full\">\r\n          URL\r\n        </TabsTrigger>\r\n        <TabsTrigger value=\"file\" className=\"w-full\">\r\n          File\r\n        </TabsTrigger>\r\n      </TabsList>\r\n      <TabsContent value=\"url\">\r\n        <InsertImageUriDialogBody onClick={onClick} />\r\n      </TabsContent>\r\n      <TabsContent value=\"file\">\r\n        <InsertImageUploadedDialogBody onClick={onClick} />\r\n      </TabsContent>\r\n    </Tabs>\r\n  )\r\n}\r\n\r\nexport function ImagesPlugin({\r\n  captionsEnabled,\r\n}: {\r\n  captionsEnabled?: boolean\r\n}): JSX.Element | null {\r\n  const [editor] = useLexicalComposerContext()\r\n\r\n  useEffect(() => {\r\n    if (!editor.hasNodes([ImageNode])) {\r\n      throw new Error('ImagesPlugin: ImageNode not registered on editor')\r\n    }\r\n\r\n    return mergeRegister(\r\n      editor.registerCommand<InsertImagePayload>(\r\n        INSERT_IMAGE_COMMAND,\r\n        (payload) => {\r\n          const imageNode = $createImageNode(payload)\r\n          $insertNodes([imageNode])\r\n          if ($isRootOrShadowRoot(imageNode.getParentOrThrow())) {\r\n            $wrapNodeInElement(imageNode, $createParagraphNode).selectEnd()\r\n          }\r\n\r\n          return true\r\n        },\r\n        COMMAND_PRIORITY_EDITOR\r\n      ),\r\n      editor.registerCommand<DragEvent>(\r\n        DRAGSTART_COMMAND,\r\n        (event) => {\r\n          return $onDragStart(event)\r\n        },\r\n        COMMAND_PRIORITY_HIGH\r\n      ),\r\n      editor.registerCommand<DragEvent>(\r\n        DRAGOVER_COMMAND,\r\n        (event) => {\r\n          return $onDragover(event)\r\n        },\r\n        COMMAND_PRIORITY_LOW\r\n      ),\r\n      editor.registerCommand<DragEvent>(\r\n        DROP_COMMAND,\r\n        (event) => {\r\n          return $onDrop(event, editor)\r\n        },\r\n        COMMAND_PRIORITY_HIGH\r\n      )\r\n    )\r\n  }, [captionsEnabled, editor])\r\n\r\n  return null\r\n}\r\n\r\nfunction $onDragStart(event: DragEvent): boolean {\r\n  const node = $getImageNodeInSelection()\r\n  if (!node) {\r\n    return false\r\n  }\r\n  const dataTransfer = event.dataTransfer\r\n  if (!dataTransfer) {\r\n    return false\r\n  }\r\n  const TRANSPARENT_IMAGE =\r\n    'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'\r\n  const img = document.createElement('img')\r\n  img.src = TRANSPARENT_IMAGE\r\n  dataTransfer.setData('text/plain', '_')\r\n  dataTransfer.setDragImage(img, 0, 0)\r\n  dataTransfer.setData(\r\n    'application/x-lexical-drag',\r\n    JSON.stringify({\r\n      data: {\r\n        altText: node.__altText,\r\n        caption: node.__caption,\r\n        height: node.__height,\r\n        key: node.getKey(),\r\n        maxWidth: node.__maxWidth,\r\n        showCaption: node.__showCaption,\r\n        src: node.__src,\r\n        width: node.__width,\r\n      },\r\n      type: 'image',\r\n    })\r\n  )\r\n\r\n  return true\r\n}\r\n\r\nfunction $onDragover(event: DragEvent): boolean {\r\n  const node = $getImageNodeInSelection()\r\n  if (!node) {\r\n    return false\r\n  }\r\n  if (!canDropImage(event)) {\r\n    event.preventDefault()\r\n  }\r\n  return true\r\n}\r\n\r\nfunction $onDrop(event: DragEvent, editor: LexicalEditor): boolean {\r\n  const node = $getImageNodeInSelection()\r\n  if (!node) {\r\n    return false\r\n  }\r\n  const data = getDragImageData(event)\r\n  if (!data) {\r\n    return false\r\n  }\r\n  event.preventDefault()\r\n  if (canDropImage(event)) {\r\n    const range = getDragSelection(event)\r\n    node.remove()\r\n    const rangeSelection = $createRangeSelection()\r\n    if (range !== null && range !== undefined) {\r\n      rangeSelection.applyDOMRange(range)\r\n    }\r\n    $setSelection(rangeSelection)\r\n    editor.dispatchCommand(INSERT_IMAGE_COMMAND, data)\r\n  }\r\n  return true\r\n}\r\n\r\nfunction $getImageNodeInSelection(): ImageNode | null {\r\n  const selection = $getSelection()\r\n  if (!$isNodeSelection(selection)) {\r\n    return null\r\n  }\r\n  const nodes = selection.getNodes()\r\n  const node = nodes[0]\r\n  return $isImageNode(node) ? node : null\r\n}\r\n\r\nfunction getDragImageData(event: DragEvent): null | InsertImagePayload {\r\n  const dragData = event.dataTransfer?.getData('application/x-lexical-drag')\r\n  if (!dragData) {\r\n    return null\r\n  }\r\n  const { type, data } = JSON.parse(dragData)\r\n  if (type !== 'image') {\r\n    return null\r\n  }\r\n\r\n  return data\r\n}\r\n\r\ndeclare global {\r\n  interface DragEvent {\r\n    rangeOffset?: number\r\n    rangeParent?: Node\r\n  }\r\n}\r\n\r\nfunction canDropImage(event: DragEvent): boolean {\r\n  const target = event.target\r\n  return !!(\r\n    target &&\r\n    target instanceof HTMLElement &&\r\n    !target.closest('code, span.editor-image') &&\r\n    target.parentElement &&\r\n    target.parentElement.closest('div.ContentEditable__root')\r\n  )\r\n}\r\n\r\nfunction getDragSelection(event: DragEvent): Range | null | undefined {\r\n  let range\r\n  const target = event.target as null | Element | Document\r\n  const targetWindow =\r\n    target == null\r\n      ? null\r\n      : target.nodeType === 9\r\n        ? (target as Document).defaultView\r\n        : (target as Element).ownerDocument.defaultView\r\n  const domSelection = getDOMSelection(targetWindow)\r\n  if (document.caretRangeFromPoint) {\r\n    range = document.caretRangeFromPoint(event.clientX, event.clientY)\r\n  } else if (event.rangeParent && domSelection !== null) {\r\n    domSelection.collapse(event.rangeParent, event.rangeOffset || 0)\r\n    range = domSelection.getRangeAt(0)\r\n  } else {\r\n    throw Error(`Cannot get the selection when dragging`)\r\n  }\r\n\r\n  return range\r\n}\r\n",
      "type": "registry:component",
      "target": "components/editor/plugins/images-plugin.tsx"
    }
  ]
}